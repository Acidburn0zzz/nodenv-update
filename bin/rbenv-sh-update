#!/usr/bin/env bash
set -e
[ -n "$RBENV_DEBUG" ] && set -x

shell="$(basename "${RBENV_SHELL:-$SHELL}")"

# Parse command line flags
if echo "$@" | egrep -q "(-n|--noop)"; then noop=true; fi
if echo "$@" | egrep -q "(-q|--quiet|--silent)"; then quiet=true; fi

case "$shell" in
  fish )
    echo "if command rbenv update $@"
    if [ -z "$quiet" ]; then
      echo "  if isatty stdout; printf \"\\e[1;32mReloading rbenv\\e[0m\\n\""
      echo "  else printf \"Reloading rbenv\\n\"; end"
    fi
    if [ -z "$noop" ]; then
      echo "  source (rbenv init -|psub)"
    fi
    if [ -z "$quiet" ]; then
      echo "  if isatty stdout; printf \" \\033[1;32m|\\033[0m  done\\n\""
      echo "  else printf \" |  done\\n\"; end"
    fi
    echo "end"
    ;;
  * )
    echo "if command rbenv update $@; then"
    if [ -z "$quiet" ]; then
      echo "  if [ -t 1 ]; then printf \"\\e[1;32mReloading rbenv\\e[0m\\n\";"
      echo "  else printf \"Reloading rbenv\\n\"; fi;"
    fi
    if [ -z "$noop" ]; then
      echo "  eval \"\$(rbenv init -)\";"
    fi
    if [ -z "$quiet" ]; then
      echo "  if [ -t 1 ]; then printf \" \\033[1;32m|\\033[0m  done\\n\";"
      echo "  else printf \" |  done\\n\"; fi;"
    fi
    echo "fi;"
    ;;
esac
